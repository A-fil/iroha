machine:
  services:
    - docker
  environment:
    IROHA_HOME: $(pwd)/iroha
    PATH: $PATH:/opt/cmake-3.5.2-Linux-x86_64/bin
    JAVA_HOME: /usr/lib/jvm/java-1.8.0-openjdk-amd64/
  java:
      version: 'oraclejdk8'

checkout:
  post:
    - git submodule sync
    - git submodule update --init --recursive


dependencies:
  cache_directories:
    - ~/iroha/core/vendor/
  override:
    - ${IROHA_HOME}/docker/build.sh


test:
  pre:
    - docker run -p 1204:1204 hyperledger/iroha-docker /test.sh || true
    - docker run -p 1204:1204 hyperledger/iroha-docker /run.sh  || true; sleep 20
    - curl -X POST http://127.0.0.1:1204/account/register -d '{"publicKey":"WdvM/DPabapmtA7ISbTYPywbHxk8gWu2221LzmcmAgw=","alias":"yonezu","timestamp":1482053586}'


deployment:
  hub:
    branch: master
    commands:
      - docker login -u ${DOCKER_USER} -p ${DOCKER_PASS}
      - docker push hyperledger/iroha-docker

